{% extends "main/index.html" %}
{% load static %}
{% block title %}
    One to one -
{% endblock %}
{% block mainstyles %}
    <link rel="stylesheet" href="{% static 'css/self-review-result.css' %}">
{% endblock %}
{% block mainContent %}
    <div class="self-review">

    <div class="form" id="head"></div>

        <div class="form">
            <div class="container">
                <h2>Итоговая обратная связь</h2>
                <table>
                    <tr>
                        <td></td>
                        <td class="table-heading">менеджер</td>
                        <td class="table-heading">пиры</td>
                        <td class="table-heading">средняя</td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Средняя оценка</td>
                        <td class="numbers-in-table"><div class="grade-number" id="average_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="average_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="average_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td colspan="4"><div class="table-title">Оценки по каждому критерию</div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Соблюдение сроков</td>
                        <td class="numbers-in-table"><div class="grade-number" id="time_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="time_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="time_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Пути достижения целей</td>
                        <td class="numbers-in-table"><div class="grade-number" id="target_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="target_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="target_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Умение работать в команде</td>
                        <td class="numbers-in-table"><div class="grade-number" id="teamwork_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="teamwork_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="teamwork_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Приверженность к хорошим техническим практикам</td>
                        <td class="numbers-in-table"><div class="grade-number" id="practices_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="practices_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="practices_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Уровень владения технологиями</td>
                        <td class="numbers-in-table"><div class="grade-number" id="technologies_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="technologies_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="technologies_avg_averages"></div></td>
                    </tr>
                    <tr>
                        <td class="text-in-table">Адаптивность</td>
                        <td class="numbers-in-table"><div class="grade-number" id="adaptive_avg_manager"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="adaptive_avg_peers"></div></td>
                        <td class="numbers-in-table"><div class="grade-number" id="adaptive_avg_averages"></div></td>
                    </tr>
                </table>
                <p class="final-grades">
                    Нормированная оценка сотрудника:<span class="grade-number great">3.02</span>
                </p>
                <p class="final-grades">
                    Средняя оценка по компании:<span class="grade-number good">2.93</span>
                </p>
            </div>

        </div>
        <!------->
        <div class="form">
            <div class="container">
                <h2 class="title-r">Self Review</h2>
                 <button onclick="myFunction()" class="peer dropbtn">
                    <a href="#" class="chevron">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </button>


                <div id="myDropdown" class="dropdown-content">
                    <div class="dropdown-container">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function myFunction() {
            document.getElementById('myDropdown').classList.toggle('show')
        };
    </script>



    <!--<script src="{% static 'js/employee_main_function.js' %}"></script>-->
    <script>
        window.onload = function (){
            get_rates(localStorage['user'])
                .then(response => response.json())
                .then(json => {
                    let final_rate = get_rates_array(json)
                    set_value(final_rate, "manager")
                    set_value(final_rate, "peers")
                    set_value(final_rate, "averages")

                    console.log(final_rate)

                })
            //localStorage.removeItem('user')
        }
        function set_value(final_rate, name){
            for (let i in final_rate[name]) {
                let el = document.getElementById(i + '_avg_' + name);
                el.innerHTML = Number(final_rate[name][i]).toFixed(2).toString();
                get_color(final_rate[name][i], el)
            }
        }
        function get_color(num, el){
            if (num < 2) {
                el.classList.add('bad')
            } else if (num >= 3) {
                el.classList.add('great')
            } else {
                el.classList.add('good')
            }
        }
        function get_rates_array(json){
            let u = json[0]
            let name = document.getElementById("head");
            name.innerHTML += u.username;
            let count = 0;
            let final_rate = {
                'manager': {
                    'time': 0.0,
                    'target': 0.0,
                    'teamwork': 0.0,
                    'practices': 0.0,
                    'technologies': 0.0,
                    'adaptive': 0.0,
                    'average': 0.0
                },
                'peers': {
                    'time': 0.0,
                    'target': 0.0,
                    'teamwork': 0.0,
                    'practices': 0.0,
                    'technologies': 0.0,
                    'adaptive': 0.0,
                    'average': 0.0
                },
                'averages': {
                    'time': 0.0,
                    'target': 0.0,
                    'teamwork': 0.0,
                    'practices': 0.0,
                    'technologies': 0.0,
                    'adaptive': 0.0,
                    'average': 0.0
                }
            }

            for (let r of u.rates) {
                if ((r['is_manager'])) {
                    let average = 0.0;
                    final_rate['manager']['time'] = Number(r['r_deadline']);
                    average += Number(r['r_deadline']);
                    final_rate['manager']['target'] = r['r_approaches'];
                    average += r['r_approaches'];
                    final_rate['manager']['teamwork'] = r['r_teamwork'];
                    average += r['r_teamwork'];
                    final_rate['manager']['practices'] = r['r_practices'];
                    average += r['r_practices'];
                    final_rate['manager']['technologies'] = r['r_experience'];
                    average += r['r_experience'];
                    final_rate['manager']['adaptive'] = r['r_adaptation'];
                    average += r['r_adaptation'];
                    final_rate['manager']['average'] = (average / 6).toFixed(2);
                } else {
                    count++;
                    final_rate['peers']['time'] += Number(r['r_deadline']);
                    final_rate['peers']['target'] += r['r_approaches'];
                    final_rate['peers']['teamwork'] += r['r_teamwork'];
                    final_rate['peers']['practices'] += r['r_practices'];
                    final_rate['peers']['technologies'] += r['r_experience'];
                    final_rate['peers']['adaptive'] += r['r_adaptation'];
                }
            }
            let average = 0.0;
            for (let r in final_rate["peers"]) {
                final_rate["peers"][r] /= count;
                final_rate["peers"][r] = final_rate["peers"][r]
                average += final_rate["peers"][r];
            }
            final_rate["peers"]['average'] = (average / 6).toFixed(2);


            final_rate['averages']['time'] = (final_rate['peers']['time'] + final_rate['manager']['time']) / 2
            final_rate['averages']['target'] = (final_rate['peers']['target'] + final_rate['manager']['target']) / 2
            final_rate['averages']['teamwork'] = (final_rate['peers']['teamwork'] + final_rate['manager']['teamwork']) / 2
            final_rate['averages']['practices'] = (final_rate['peers']['practices'] + final_rate['manager']['practices']) / 2
            final_rate['averages']['technologies'] = (final_rate['peers']['technologies'] + final_rate['manager']['technologies']) / 2
            final_rate['averages']['adaptive'] = (final_rate['peers']['adaptive'] + final_rate['manager']['adaptive']) / 2
            final_rate['averages']['average'] = (Number(final_rate['peers']['average']) + Number(final_rate['manager']['average'])) / 2
            return final_rate;
        }
        function get_rates(id) {
            return fetch(window.location.origin + "/perforator/imanager/employee/rating?id=" + id);
        }
        function get_team(){
            return fetch(window.location.origin + "/perforator/team");
        }
    </script>
{% endblock %}